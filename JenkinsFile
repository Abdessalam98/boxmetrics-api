node {
 stage('Checkout') {
  checkout scm
 }
 stage('Environment') {
  sh 'git --version'
  echo "Build number : ${env.BUILD_NUMBER}"
 }
 stage('Build and Push') {
  withCredentials([string(credentialsId: 'SERVER', variable: 'SERVER')]) {
   withDockerRegistry(url: 'http://${SERVER}', credentialsId: 'e56a6c40-97c8-4a3c-afbb-ff7182917c31', ) {
    app = docker.build("${SERVER}/boxmetrics-api:${env.BRANCH_NAME}-build-${env.BUILD_NUMBER}")
    app.push()
   }
  }
 }
 stage('Deploy to Dev') {
withCredentials([string(credentialsId: 'SERVER', variable: 'SERVER')]) {
  withDockerRegistry(url: 'http://${SERVER}', credentialsId: 'e56a6c40-97c8-4a3c-afbb-ff7182917c31', ) {
  sh 'docker stop boxmetrics-api-dev || true' 
  sh 'docker rm boxmetrics-api-dev || true '
  sh "docker run -d -p 8181:8181 --env-file=/srv/boxmetrics/api/.env --name boxmetrics-api-dev ${SERVER}/boxmetrics-api:${env.BRANCH_NAME}-build-${env.BUILD_NUMBER}"
  }
}
 }
}